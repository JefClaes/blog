<!DOCTYPE html>
<html>
<head><script src="/livereload.js?port=1313&mindelay=10&v=2" data-no-instant defer></script>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Designing entities: immutability first - Jef Claes</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta itemprop="name" content="Designing entities: immutability first">
<meta itemprop="description" content="The first year I wrote software for a living I spent my days mostly writing forms over data applications; most of my efforts were wasted just trying to make things work using ASP.NET and the Webforms engine. It was only after a year and graduating from the School of Hard Knocks that I learned there is a lot more to building clean and maintainable software than knowing the ins&rsquo; and outs&rsquo; of a proprietary UI technology.">
<meta itemprop="datePublished" content="2013-04-07T17:35:00&#43;02:00" />
<meta itemprop="dateModified" content="2013-04-07T17:35:00&#43;02:00" />
<meta itemprop="wordCount" content="1517">



<meta itemprop="keywords" content="code,opinion," /><meta property="og:title" content="Designing entities: immutability first" />
<meta property="og:description" content="The first year I wrote software for a living I spent my days mostly writing forms over data applications; most of my efforts were wasted just trying to make things work using ASP.NET and the Webforms engine. It was only after a year and graduating from the School of Hard Knocks that I learned there is a lot more to building clean and maintainable software than knowing the ins&rsquo; and outs&rsquo; of a proprietary UI technology." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:1313/2013/04/designing-entities-immutability-first.html" />
<meta property="article:published_time" content="2013-04-07T17:35:00+02:00" />
<meta property="article:modified_time" content="2013-04-07T17:35:00+02:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Designing entities: immutability first"/>
<meta name="twitter:description" content="The first year I wrote software for a living I spent my days mostly writing forms over data applications; most of my efforts were wasted just trying to make things work using ASP.NET and the Webforms engine. It was only after a year and graduating from the School of Hard Knocks that I learned there is a lot more to building clean and maintainable software than knowing the ins&rsquo; and outs&rsquo; of a proprietary UI technology."/>
<link href='https://fonts.googleapis.com/css?family=Playfair+Display:700' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" type="text/css" media="screen" href="http://localhost:1313/css/normalize.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="http://localhost:1313/css/main.css" />

        <link id="dark-scheme" rel="stylesheet" type="text/css" href="http://localhost:1313/css/dark.css" />

	<script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
		<script src="http://localhost:1313/js/main.js"></script>
</head>

<body>
	<div class="container wrapper">
		<div class="header">
	
		<div class="avatar">
			<a href="http://localhost:1313/">
				<img src="https://image.freepik.com/free-vector/young-man-head-with-beard-avatar-character_24877-36786.jpg" alt="Jef Claes" />
			</a>
		</div>
	
	<h1 class="site-title"><a href="http://localhost:1313/">Jef Claes</a></h1>
	<div class="site-description"><p>On software and life</p><nav class="nav social">
			<ul class="flat"><li><a href="https://github.com/jefclaes" title="Github"><i data-feather="github"></i></a></li><li><a href="/index.xml" title="RSS"><i data-feather="rss"></i></a></li></ul>
		</nav></div>

	<nav class="nav">
		<ul class="flat">
			
			<li>
				<a href="/">Home</a>
			</li>
			
			<li>
				<a href="/post">All posts</a>
			</li>
			
			<li>
				<a href="/about">About</a>
			</li>
			
			<li>
				<a href="/tags">Tags</a>
			</li>
			
		</ul>
	</nav>
</div>


		<div class="post">
			<div class="post-header">
				
					<div class="meta">
						<div class="date">
							<span class="day">07</span>
							<span class="rest">Apr 2013</span>
						</div>
					</div>
				
				<div class="matter">
					<h1 class="title">Designing entities: immutability first</h1>
				</div>
			</div>
					
			<div class="markdown">
				<p>The first year I wrote software for a living I spent my days mostly
writing forms over data applications; most of my efforts were wasted
just trying to make things work using ASP.NET and the Webforms engine.
It was only after a year and graduating from the School of Hard Knocks
that I learned there is a lot more to building clean and maintainable
software than knowing the ins&rsquo; and outs&rsquo; of a proprietary UI
technology.</p>
<p>One of the habits I have adapted over time, is designing new entities as
immutable objects first, and to go from there. I believe this helps me
to make more deliberate design decisions, leading to better designs.</p>
<p>Allow me to demonstrate this using a customer entity - I know this is
cliché, but I have a hard time coming up with original examples.</p>
<h3 id="a-constructor">A constructor</h3>
<p>This one might sound rather obvious, but you would be surprised how many
classes don&rsquo;t have the decency of a simple constructor, especially since
C# introduced <a href="http://msdn.microsoft.com/en-us/library/vstudio/bb384062.aspx">object
initializers</a>.
While object initializers definitely look good, they make your code
harder to maintain; classes don&rsquo;t communicate what they need to get by,
nor do they get the opportunity to protect their invariants as early as
possible.</p>
<p>Like I said, I design my classes to be immutable from the start; after
initialization they can&rsquo;t be modified. I&rsquo;m not even exposing any state
for now.</p>
<div class="highlight"><pre style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#859900">public</span> <span style="color:#859900">class</span> <span style="color:#cb4b16">Customer</span>
{
    <span style="color:#859900">public</span> <span style="color:#268bd2">Customer</span>(
        <span style="color:#268bd2">Guid</span> <span style="color:#268bd2">id</span>,
        <span style="color:#859900;font-weight:bold">string</span> <span style="color:#268bd2">firstName</span>,
        <span style="color:#859900;font-weight:bold">string</span> <span style="color:#268bd2">lastName</span>,
        <span style="color:#859900;font-weight:bold">string</span> <span style="color:#268bd2">street</span>,
        <span style="color:#859900;font-weight:bold">string</span> <span style="color:#268bd2">city</span>,
        <span style="color:#859900;font-weight:bold">string</span> <span style="color:#268bd2">country</span>,
        <span style="color:#268bd2">DateTime</span> <span style="color:#268bd2">birthdate</span>,
        <span style="color:#859900;font-weight:bold">decimal</span> <span style="color:#268bd2">balance</span>)
    {
        <span style="color:#268bd2">FirstName</span> = <span style="color:#268bd2">firstName</span>;
        <span style="color:#268bd2">LastName</span> = <span style="color:#268bd2">lastName</span>;
        <span style="color:#268bd2">Street</span> = <span style="color:#268bd2">street</span>;
        <span style="color:#268bd2">City</span> = <span style="color:#268bd2">city</span>;
        <span style="color:#268bd2">Country</span> = <span style="color:#268bd2">country</span>;
        <span style="color:#268bd2">BirthDate</span> = <span style="color:#268bd2">birthdate</span>;
        <span style="color:#268bd2">Balance</span> = <span style="color:#268bd2">balance</span>;
    }

    <span style="color:#859900">public</span> <span style="color:#268bd2">Guid</span> <span style="color:#268bd2">Id</span> { <span style="color:#859900">get</span>; <span style="color:#859900">private</span> <span style="color:#859900">set</span>; }
    <span style="color:#859900">private</span> <span style="color:#859900;font-weight:bold">string</span> <span style="color:#268bd2">FirstName</span> { <span style="color:#859900">get</span>; <span style="color:#859900">set</span>; }
    <span style="color:#859900">private</span> <span style="color:#859900;font-weight:bold">string</span> <span style="color:#268bd2">LastName</span> { <span style="color:#859900">get</span>; <span style="color:#859900">set</span>; }
    <span style="color:#859900">private</span> <span style="color:#859900;font-weight:bold">string</span> <span style="color:#268bd2">Street</span> { <span style="color:#859900">get</span>; <span style="color:#859900">set</span>; }
    <span style="color:#859900">private</span> <span style="color:#859900;font-weight:bold">string</span> <span style="color:#268bd2">City</span> { <span style="color:#859900">get</span>; <span style="color:#859900">set</span>; }
    <span style="color:#859900">private</span> <span style="color:#859900;font-weight:bold">string</span> <span style="color:#268bd2">Country</span> { <span style="color:#859900">get</span>; <span style="color:#859900">set</span>; }
    <span style="color:#859900">private</span> <span style="color:#268bd2">DateTime</span> <span style="color:#268bd2">BirthDate</span> { <span style="color:#859900">get</span>; <span style="color:#859900">set</span>; }
    <span style="color:#859900">private</span> <span style="color:#859900;font-weight:bold">decimal</span> <span style="color:#268bd2">Balance</span> { <span style="color:#859900">get</span>; <span style="color:#859900">set</span>; }
}
</code></pre></div><h3 id="comparing-identities">Comparing identities</h3>
<p>An entity is always unique within a system; it has an identity. To
encapsulate comparing two entities, and to avoid repeating myself, I
always override the Equals and GetHashCode methods. We&rsquo;re not guided
into doing this by our object&rsquo;s immutability though, but by common
sense.</p>
<div class="highlight"><pre style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#859900">public</span> <span style="color:#859900">override</span> <span style="color:#859900;font-weight:bold">bool</span> <span style="color:#268bd2">Equals</span>(<span style="color:#859900;font-weight:bold">object</span> <span style="color:#268bd2">obj</span>)
{
    <span style="color:#859900">if</span> (<span style="color:#268bd2">obj</span> == <span style="color:#859900">null</span> || <span style="color:#268bd2">GetType</span>() != <span style="color:#268bd2">obj</span>.<span style="color:#268bd2">GetType</span>())
        <span style="color:#859900">return</span> <span style="color:#859900">false</span>;            

    <span style="color:#859900;font-weight:bold">var</span> <span style="color:#268bd2">other</span> = <span style="color:#268bd2">obj</span> <span style="color:#859900">as</span> <span style="color:#268bd2">Customer</span>;
        
    <span style="color:#859900">return</span> <span style="color:#268bd2">Id</span> == <span style="color:#268bd2">other</span>.<span style="color:#268bd2">Id</span>;
}

<span style="color:#859900">public</span> <span style="color:#859900">override</span> <span style="color:#859900;font-weight:bold">int</span> <span style="color:#268bd2">GetHashCode</span>()
{
    <span style="color:#859900">return</span> <span style="color:#859900">this</span>.<span style="color:#268bd2">Id</span>.<span style="color:#268bd2">GetHashCode</span>();
}
</code></pre></div><h3 id="defaults">Defaults</h3>
<p>When a new customer is created, its balance is still empty. The
constructor is the perfect place to initialize this default.</p>
<div class="highlight"><pre style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#859900">public</span> <span style="color:#268bd2">Customer</span>(
    <span style="color:#268bd2">Guid</span> <span style="color:#268bd2">id</span>,
    <span style="color:#859900;font-weight:bold">string</span> <span style="color:#268bd2">firstName</span>,
    <span style="color:#859900;font-weight:bold">string</span> <span style="color:#268bd2">lastName</span>,
    <span style="color:#859900;font-weight:bold">string</span> <span style="color:#268bd2">street</span>,
    <span style="color:#859900;font-weight:bold">string</span> <span style="color:#268bd2">city</span>,
    <span style="color:#859900;font-weight:bold">string</span> <span style="color:#268bd2">country</span>,
    <span style="color:#268bd2">DateTime</span> <span style="color:#268bd2">birthdate</span>)
{
    <span style="color:#268bd2">FirstName</span> = <span style="color:#268bd2">firstName</span>;
    <span style="color:#268bd2">LastName</span> = <span style="color:#268bd2">lastName</span>;
    <span style="color:#268bd2">Street</span> = <span style="color:#268bd2">street</span>;
    <span style="color:#268bd2">City</span> = <span style="color:#268bd2">city</span>;
    <span style="color:#268bd2">Country</span> = <span style="color:#268bd2">country</span>;
    <span style="color:#268bd2">BirthDate</span> = <span style="color:#268bd2">birthdate</span>;
    <span style="color:#268bd2">Balance</span> = <span style="color:#2aa198;font-weight:bold">0</span>;
}
</code></pre></div><h2 id="protecting-invariants">Protecting invariants</h2>
<p>The next thing I&rsquo;ll do is use the constructor to guard for arguments
that don&rsquo;t satisfy my objects invariants. This way we guarantee that the
object can never be initialized with an invalid state; avoiding a bunch
of trouble along the way.</p>
<p>We expect a customer to have a first name, last name, street, city and
country which isn&rsquo;t empty. We also expect its birth date not to be in
the future.</p>
<div class="highlight"><pre style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#859900">public</span> <span style="color:#268bd2">Customer</span>(
    <span style="color:#268bd2">Guid</span> <span style="color:#268bd2">id</span>,
    <span style="color:#859900;font-weight:bold">string</span> <span style="color:#268bd2">firstName</span>,
    <span style="color:#859900;font-weight:bold">string</span> <span style="color:#268bd2">lastName</span>,
    <span style="color:#859900;font-weight:bold">string</span> <span style="color:#268bd2">street</span>,
    <span style="color:#859900;font-weight:bold">string</span> <span style="color:#268bd2">city</span>,
    <span style="color:#859900;font-weight:bold">string</span> <span style="color:#268bd2">country</span>,
    <span style="color:#268bd2">DateTime</span> <span style="color:#268bd2">birthdate</span>)
{
    <span style="color:#268bd2">Guard</span>.<span style="color:#268bd2">ForNullOrEmpty</span>(<span style="color:#268bd2">firstName</span>, <span style="color:#2aa198">&#34;first name&#34;</span>);
    <span style="color:#268bd2">Guard</span>.<span style="color:#268bd2">ForNullOrEmpty</span>(<span style="color:#268bd2">lastName</span>, <span style="color:#2aa198">&#34;last name&#34;</span>);
    <span style="color:#268bd2">Guard</span>.<span style="color:#268bd2">ForNullOrEmpty</span>(<span style="color:#268bd2">street</span>, <span style="color:#2aa198">&#34;street&#34;</span>);
    <span style="color:#268bd2">Guard</span>.<span style="color:#268bd2">ForNullOrEmpty</span>(<span style="color:#268bd2">city</span>, <span style="color:#2aa198">&#34;city&#34;</span>);
    <span style="color:#268bd2">Guard</span>.<span style="color:#268bd2">ForNullOrEmpty</span>(<span style="color:#268bd2">country</span>, <span style="color:#2aa198">&#34;country&#34;</span>);
    <span style="color:#268bd2">Guard</span>.<span style="color:#268bd2">ForDatesInTheFuture</span>(<span style="color:#268bd2">birthdate</span>, <span style="color:#2aa198">&#34;birthdate&#34;</span>);

    <span style="color:#268bd2">Id</span> = <span style="color:#268bd2">id</span>;
    <span style="color:#268bd2">FirstName</span> = <span style="color:#268bd2">firstName</span>;
    <span style="color:#268bd2">LastName</span> = <span style="color:#268bd2">lastName</span>;
    <span style="color:#268bd2">Street</span> = <span style="color:#268bd2">street</span>;
    <span style="color:#268bd2">City</span> = <span style="color:#268bd2">city</span>;
    <span style="color:#268bd2">Country</span> = <span style="color:#268bd2">country</span>;
    <span style="color:#268bd2">BirthDate</span> = <span style="color:#268bd2">birthdate</span>;            
    <span style="color:#268bd2">Balance</span> = <span style="color:#2aa198;font-weight:bold">0</span>;
}

<span style="color:#859900">public</span> <span style="color:#859900">class</span> <span style="color:#cb4b16">Guard</span>
{
    <span style="color:#859900">public</span> <span style="color:#859900">static</span> <span style="color:#859900">void</span> <span style="color:#268bd2">ForNullOrEmpty</span>(<span style="color:#859900;font-weight:bold">string</span> <span style="color:#859900">value</span>, <span style="color:#859900;font-weight:bold">string</span> <span style="color:#268bd2">desc</span>)
    {
        <span style="color:#859900">if</span> (<span style="color:#859900;font-weight:bold">string</span>.<span style="color:#268bd2">IsNullOrEmpty</span>(<span style="color:#859900">value</span>))
            <span style="color:#859900">throw</span> <span style="color:#859900">new</span> <span style="color:#268bd2">NullReferenceException</span>(<span style="color:#268bd2">desc</span>);
    }

    <span style="color:#859900">public</span> <span style="color:#859900">static</span> <span style="color:#859900">void</span> <span style="color:#268bd2">ForDateInTheFuture</span>(<span style="color:#268bd2">DateTime</span> <span style="color:#859900">value</span>, <span style="color:#859900;font-weight:bold">string</span> <span style="color:#268bd2">desc</span>)
    {
        <span style="color:#859900">if</span> (<span style="color:#859900">value</span> &gt; <span style="color:#268bd2">DateTimeProvider</span>.<span style="color:#268bd2">Now</span>())
            <span style="color:#859900">throw</span> <span style="color:#859900">new</span> <span style="color:#268bd2">ArgumentException</span>(
                <span style="color:#859900;font-weight:bold">string</span>.<span style="color:#268bd2">Format</span>(<span style="color:#2aa198">&#34;{0} can&#39;t be a date in the future.&#34;</span>, <span style="color:#268bd2">desc</span>))
    }
}
</code></pre></div><h3 id="composition-and-extracting-value-objects">Composition and extracting value objects</h3>
<p>I&rsquo;m fairly confident that every self-respecting programmer is annoyed
by the fact that the obvious concepts name and address haven&rsquo;t been
extracted yet. Especially since that bloated constructor is all up in
your face. Let&rsquo;s go ahead and extract two value objects: name and
address.</p>
<div class="highlight"><pre style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#859900">public</span> <span style="color:#859900">class</span> <span style="color:#cb4b16">Customer</span>
{
    <span style="color:#859900">public</span> <span style="color:#268bd2">Customer</span>(
        <span style="color:#268bd2">Guid</span> <span style="color:#268bd2">id</span>,
        <span style="color:#268bd2">Name</span> <span style="color:#268bd2">name</span>,
        <span style="color:#268bd2">Address</span> <span style="color:#268bd2">address</span>,
        <span style="color:#268bd2">DateTime</span> <span style="color:#268bd2">birthdate</span>)
    {
        <span style="color:#268bd2">Guard</span>.<span style="color:#268bd2">ForNull</span>(<span style="color:#268bd2">name</span>, <span style="color:#2aa198">&#34;name&#34;</span>);
        <span style="color:#268bd2">Guard</span>.<span style="color:#268bd2">ForNull</span>(<span style="color:#268bd2">address</span>, <span style="color:#2aa198">&#34;address&#34;</span>);
        <span style="color:#268bd2">Guard</span>.<span style="color:#268bd2">ForDateInTheFuture</span>(<span style="color:#268bd2">birthdate</span>, <span style="color:#2aa198">&#34;birthdate&#34;</span>);

        <span style="color:#268bd2">Id</span> = <span style="color:#268bd2">id</span>;
        <span style="color:#268bd2">Name</span> = <span style="color:#268bd2">name</span>;
        <span style="color:#268bd2">Address</span> = <span style="color:#268bd2">address</span>;
        <span style="color:#268bd2">Balance</span> = <span style="color:#2aa198;font-weight:bold">0</span>;
    }

    <span style="color:#859900">public</span> <span style="color:#268bd2">Guid</span> <span style="color:#268bd2">Id</span> { <span style="color:#859900">get</span>; <span style="color:#859900">private</span> <span style="color:#859900">set</span>; }
    <span style="color:#859900">private</span> <span style="color:#268bd2">Name</span> <span style="color:#268bd2">Name</span> { <span style="color:#859900">get</span>; <span style="color:#859900">set</span>; }
    <span style="color:#859900">private</span> <span style="color:#268bd2">Address</span> <span style="color:#268bd2">Address</span> { <span style="color:#859900">get</span>; <span style="color:#859900">set</span>; }
    <span style="color:#859900">private</span> <span style="color:#268bd2">DateTime</span> <span style="color:#268bd2">BirthDate</span> { <span style="color:#859900">get</span>; <span style="color:#859900">set</span>; }
    <span style="color:#859900">private</span> <span style="color:#859900;font-weight:bold">decimal</span> <span style="color:#268bd2">Balance</span> { <span style="color:#859900">get</span>; <span style="color:#859900">set</span>; }
}

<span style="color:#859900">public</span> <span style="color:#859900">class</span> <span style="color:#cb4b16">Name</span>
{
    <span style="color:#859900">public</span> <span style="color:#268bd2">Name</span>(<span style="color:#859900;font-weight:bold">string</span> <span style="color:#268bd2">first</span>, <span style="color:#859900;font-weight:bold">string</span> <span style="color:#268bd2">last</span>)
    {
        <span style="color:#268bd2">Guard</span>.<span style="color:#268bd2">ForNullOrEmpty</span>(<span style="color:#268bd2">first</span>, <span style="color:#2aa198">&#34;first name&#34;</span>);
        <span style="color:#268bd2">Guard</span>.<span style="color:#268bd2">ForNullOrEmpty</span>(<span style="color:#268bd2">last</span>, <span style="color:#2aa198">&#34;last name&#34;</span>);

        <span style="color:#268bd2">First</span> = <span style="color:#268bd2">first</span>;
        <span style="color:#268bd2">Last</span> = <span style="color:#268bd2">last</span>;
    }

    <span style="color:#859900">private</span> <span style="color:#859900;font-weight:bold">string</span> <span style="color:#268bd2">First</span> { <span style="color:#859900">get</span>; <span style="color:#859900">set</span>; }
    <span style="color:#859900">private</span> <span style="color:#859900;font-weight:bold">string</span> <span style="color:#268bd2">Last</span> { <span style="color:#859900">get</span>; <span style="color:#859900">set</span>; }

    <span style="color:#859900">public</span> <span style="color:#859900;font-weight:bold">string</span> <span style="color:#268bd2">Full</span> 
    {
        <span style="color:#859900">get</span>
        {
            <span style="color:#859900">return</span> <span style="color:#859900;font-weight:bold">string</span>.<span style="color:#268bd2">Format</span>(<span style="color:#2aa198">&#34;{0} {1}&#34;</span>, <span style="color:#268bd2">First</span>, <span style="color:#268bd2">Last</span>);
        }
    }
    
    <span style="color:#859900">public</span> <span style="color:#859900">override</span> <span style="color:#859900;font-weight:bold">bool</span> <span style="color:#268bd2">Equals</span>(<span style="color:#268bd2">Object</span> <span style="color:#268bd2">obj</span>)
    {
        ...
    }
    
    <span style="color:#859900">public</span> <span style="color:#859900">override</span> <span style="color:#859900;font-weight:bold">int</span> <span style="color:#268bd2">GetHashCode</span>()
    {
        ...
    }
}

<span style="color:#859900">public</span> <span style="color:#859900">class</span> <span style="color:#cb4b16">Address</span>
{
    <span style="color:#859900">public</span> <span style="color:#268bd2">Address</span>(<span style="color:#859900;font-weight:bold">string</span> <span style="color:#268bd2">street</span>, <span style="color:#859900;font-weight:bold">string</span> <span style="color:#268bd2">city</span>, <span style="color:#859900;font-weight:bold">string</span> <span style="color:#268bd2">country</span>)
    {
        <span style="color:#268bd2">Guard</span>.<span style="color:#268bd2">ForNullOrEmpty</span>(<span style="color:#268bd2">street</span>, <span style="color:#2aa198">&#34;street&#34;</span>);
        <span style="color:#268bd2">Guard</span>.<span style="color:#268bd2">ForNullOrEmpty</span>(<span style="color:#268bd2">city</span>, <span style="color:#2aa198">&#34;city&#34;</span>);
        <span style="color:#268bd2">Guard</span>.<span style="color:#268bd2">ForNullOrEmpty</span>(<span style="color:#268bd2">country</span>, <span style="color:#2aa198">&#34;country&#34;</span>);

        <span style="color:#268bd2">Street</span> = <span style="color:#268bd2">street</span>;
        <span style="color:#268bd2">City</span> = <span style="color:#268bd2">city</span>;
        <span style="color:#268bd2">Country</span> = <span style="color:#268bd2">country</span>;
    }

    <span style="color:#859900">private</span> <span style="color:#859900;font-weight:bold">string</span> <span style="color:#268bd2">Street</span> { <span style="color:#859900">get</span>; <span style="color:#859900">set</span>; }
    <span style="color:#859900">private</span> <span style="color:#859900;font-weight:bold">string</span> <span style="color:#268bd2">City</span> { <span style="color:#859900">get</span>; <span style="color:#859900">set</span>; }
    <span style="color:#859900">private</span> <span style="color:#859900;font-weight:bold">string</span> <span style="color:#268bd2">Country</span> { <span style="color:#859900">get</span>; <span style="color:#859900">set</span>; }
    
    <span style="color:#859900">public</span> <span style="color:#859900">override</span> <span style="color:#859900;font-weight:bold">bool</span> <span style="color:#268bd2">Equals</span>(<span style="color:#268bd2">Object</span> <span style="color:#268bd2">obj</span>)
    {
        ...
    }
    
    <span style="color:#859900">public</span> <span style="color:#859900">override</span> <span style="color:#859900;font-weight:bold">int</span> <span style="color:#268bd2">GetHashCode</span>()
    {
        ...
    }
}
</code></pre></div><p>There, that looks better.</p>
<h3 id="tell-dont-ask">Tell, don&rsquo;t ask</h3>
<p>In good OOP we tell objects what to do, we don&rsquo;t want to query an
object for its state and do something based on that; that would lead to
broken encapsulation and thereby more brittle code.</p>
<p>Since our immutable object isn&rsquo;t exposing any state yet, we are forced
to ask ourselves why we want to expose something. This way, disregarding
&ldquo;tell don&rsquo;t ask&rdquo; becomes a deliberate choice.</p>
<p>Let&rsquo;s say we want to decrease the balance, and throw an exception when
funds are insufficient. Instead of asking the customer instance and
acting on that..</p>
<div class="highlight"><pre style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#859900">if</span> (!<span style="color:#268bd2">customer</span>.<span style="color:#268bd2">HasSufficientFunds</span>())
    <span style="color:#859900">throw</span> <span style="color:#859900">new</span> <span style="color:#268bd2">InsufficientFundsException</span>();
</code></pre></div><p>It&rsquo;s better to encapsulate data and behaviour, and tell it what to do
instead.</p>
<div class="highlight"><pre style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#859900">public</span> <span style="color:#859900">class</span> <span style="color:#cb4b16">Customer</span>
{
    <span style="color:#859900">public</span> <span style="color:#268bd2">Customer</span>(
        <span style="color:#268bd2">Guid</span> <span style="color:#268bd2">id</span>,
        <span style="color:#268bd2">Name</span> <span style="color:#268bd2">name</span>,
        <span style="color:#268bd2">Address</span> <span style="color:#268bd2">address</span>,
        <span style="color:#268bd2">DateTime</span> <span style="color:#268bd2">birthdate</span>)
    {
        <span style="color:#268bd2">Guard</span>.<span style="color:#268bd2">ForNull</span>(<span style="color:#268bd2">name</span>, <span style="color:#2aa198">&#34;name&#34;</span>);
        <span style="color:#268bd2">Guard</span>.<span style="color:#268bd2">ForNull</span>(<span style="color:#268bd2">address</span>, <span style="color:#2aa198">&#34;address&#34;</span>);
        <span style="color:#268bd2">Guard</span>.<span style="color:#268bd2">ForDateInTheFuture</span>(<span style="color:#268bd2">birthdate</span>, <span style="color:#2aa198">&#34;birthdate&#34;</span>);

        <span style="color:#268bd2">Id</span> = <span style="color:#268bd2">id</span>;
        <span style="color:#268bd2">Name</span> = <span style="color:#268bd2">name</span>;
        <span style="color:#268bd2">Address</span> = <span style="color:#268bd2">address</span>;
        <span style="color:#268bd2">Balance</span> = <span style="color:#2aa198;font-weight:bold">0</span>;
    }

    <span style="color:#859900">public</span> <span style="color:#268bd2">Guid</span> <span style="color:#268bd2">Id</span> { <span style="color:#859900">get</span>; <span style="color:#859900">private</span> <span style="color:#859900">set</span>; }        
    <span style="color:#859900">private</span> <span style="color:#268bd2">Name</span> <span style="color:#268bd2">Name</span> { <span style="color:#859900">get</span>; <span style="color:#859900">set</span>; }
    <span style="color:#859900">private</span> <span style="color:#268bd2">Address</span> <span style="color:#268bd2">Address</span> { <span style="color:#859900">get</span>; <span style="color:#859900">set</span>; }
    <span style="color:#859900">private</span> <span style="color:#268bd2">DateTime</span> <span style="color:#268bd2">BirthDate</span> { <span style="color:#859900">get</span>; <span style="color:#859900">set</span>; }
    <span style="color:#859900">private</span> <span style="color:#859900;font-weight:bold">decimal</span> <span style="color:#268bd2">Balance</span> { <span style="color:#859900">get</span>; <span style="color:#859900">set</span>; }

    <span style="color:#859900">private</span> <span style="color:#859900;font-weight:bold">bool</span> <span style="color:#268bd2">HasSufficientFunds</span>(<span style="color:#859900;font-weight:bold">decimal</span> <span style="color:#859900">value</span>) 
    {
        <span style="color:#859900">return</span> <span style="color:#268bd2">Balance</span> - <span style="color:#859900">value</span> &gt;= <span style="color:#2aa198;font-weight:bold">0</span>;
    }

    <span style="color:#859900">public</span> <span style="color:#859900">void</span> <span style="color:#268bd2">DecreaseBalance</span>(<span style="color:#859900;font-weight:bold">decimal</span> <span style="color:#859900">value</span>)
    {
        <span style="color:#859900">if</span> (<span style="color:#268bd2">HasSufficientFunds</span>(<span style="color:#859900">value</span>))
            <span style="color:#859900">throw</span> <span style="color:#859900">new</span> <span style="color:#268bd2">InsufficientFundsException</span>();

        <span style="color:#268bd2">Balance</span> -= <span style="color:#859900">value</span>;
    }
}
</code></pre></div><h3 id="making-operations-explicit">Making operations explicit</h3>
<p>Next thing we want to do is change the address of a customer. Since
we&rsquo;re not exposing the address property directly, we&rsquo;re also forced to
think about a useful name for the operation; I decided to name it
MoveTo. With this we make things more explicit, and thus more evident
for people who are new to the domain.</p>
<div class="highlight"><pre style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#859900">public</span> <span style="color:#859900">class</span> <span style="color:#cb4b16">Customer</span>
{
    <span style="color:#859900">public</span> <span style="color:#268bd2">Customer</span>(
        <span style="color:#268bd2">Guid</span> <span style="color:#268bd2">id</span>,
        <span style="color:#268bd2">Name</span> <span style="color:#268bd2">name</span>,
        <span style="color:#268bd2">Address</span> <span style="color:#268bd2">address</span>,
        <span style="color:#268bd2">DateTime</span> <span style="color:#268bd2">birthdate</span>)
    {
        <span style="color:#268bd2">Guard</span>.<span style="color:#268bd2">ForNull</span>(<span style="color:#268bd2">name</span>, <span style="color:#2aa198">&#34;name&#34;</span>);
        <span style="color:#268bd2">Guard</span>.<span style="color:#268bd2">ForNull</span>(<span style="color:#268bd2">address</span>, <span style="color:#2aa198">&#34;address&#34;</span>);
        <span style="color:#268bd2">Guard</span>.<span style="color:#268bd2">ForDateInTheFuture</span>(<span style="color:#268bd2">birthdate</span>, <span style="color:#2aa198">&#34;birthdate&#34;</span>);

        <span style="color:#268bd2">Id</span> = <span style="color:#268bd2">id</span>;
        <span style="color:#268bd2">Name</span> = <span style="color:#268bd2">name</span>;
        <span style="color:#268bd2">Address</span> = <span style="color:#268bd2">address</span>;
        <span style="color:#268bd2">Balance</span> = <span style="color:#2aa198;font-weight:bold">0</span>;
    }

    <span style="color:#859900">public</span> <span style="color:#268bd2">Guid</span> <span style="color:#268bd2">Id</span> { <span style="color:#859900">get</span>; <span style="color:#859900">private</span> <span style="color:#859900">set</span>; }    
    <span style="color:#859900">private</span> <span style="color:#268bd2">Name</span> <span style="color:#268bd2">Name</span> { <span style="color:#859900">get</span>; <span style="color:#859900">set</span>; }
    <span style="color:#859900">private</span> <span style="color:#268bd2">Address</span> <span style="color:#268bd2">Address</span> { <span style="color:#859900">get</span>; <span style="color:#859900">set</span>; }
    <span style="color:#859900">private</span> <span style="color:#268bd2">DateTime</span> <span style="color:#268bd2">BirthDate</span> { <span style="color:#859900">get</span>; <span style="color:#859900">set</span>; }
    <span style="color:#859900">private</span> <span style="color:#859900;font-weight:bold">decimal</span> <span style="color:#268bd2">Balance</span> { <span style="color:#859900">get</span>; <span style="color:#859900">set</span>; }

    ...

    <span style="color:#859900">public</span> <span style="color:#859900">void</span> <span style="color:#268bd2">MoveTo</span>(<span style="color:#268bd2">Address</span> <span style="color:#268bd2">newAddress</span>)
    {
        <span style="color:#268bd2">Guard</span>.<span style="color:#268bd2">ForNull</span>(<span style="color:#268bd2">newAddress</span>, <span style="color:#2aa198">&#34;new address&#34;</span>);

        <span style="color:#268bd2">Address</span> = <span style="color:#268bd2">newAddress</span>;
    }
}

<span style="color:#859900;font-weight:bold">var</span> <span style="color:#268bd2">customer</span> = <span style="color:#859900">new</span> <span style="color:#268bd2">Customer</span>(
    <span style="color:#268bd2">Guid</span>.<span style="color:#268bd2">NewGuid</span>(),
    <span style="color:#859900">new</span> <span style="color:#268bd2">Name</span>(<span style="color:#2aa198">&#34;Jef&#34;</span>, <span style="color:#2aa198">&#34;Claes&#34;</span>),
    <span style="color:#859900">new</span> <span style="color:#268bd2">Address</span>(<span style="color:#2aa198">&#34;Ergens&#34;</span>, <span style="color:#2aa198">&#34;Antwerp&#34;</span>, <span style="color:#2aa198">&#34;Belgium&#34;</span>),
    <span style="color:#859900">new</span> <span style="color:#268bd2">DateTime</span>(<span style="color:#2aa198;font-weight:bold">1987</span>, <span style="color:#2aa198;font-weight:bold">10</span>, <span style="color:#2aa198;font-weight:bold">18</span>));

<span style="color:#268bd2">customer</span>.<span style="color:#268bd2">MoveTo</span>(<span style="color:#859900">new</span> <span style="color:#268bd2">Address</span>(<span style="color:#2aa198">&#34;Quelque part&#34;</span>, <span style="color:#2aa198">&#34;Brussels&#34;</span>, <span style="color:#2aa198">&#34;Belgium&#34;</span>));
</code></pre></div><h3 id="opening-up-bit-by-bit">Opening up bit by bit</h3>
<p>In the meanwhile our entity is no longer immutable, but we&rsquo;re doing a
good job of not exposing any state. If you&rsquo;re using the same model for
reads as you do for writes, you&rsquo;re going to need to expose some
properties eventually; for querying, but also for assertions. Make sure
to only expose the getters though, and to avoid violating &ldquo;Tell, don&rsquo;t
ask&rdquo; since that became a lot easier now.</p>
<div class="highlight"><pre style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#859900">public</span> <span style="color:#859900">class</span> <span style="color:#cb4b16">Customer</span>
{
    <span style="color:#859900">public</span> <span style="color:#268bd2">Customer</span>(
        <span style="color:#268bd2">Guid</span> <span style="color:#268bd2">id</span>,
        <span style="color:#268bd2">Name</span> <span style="color:#268bd2">name</span>,
        <span style="color:#268bd2">Address</span> <span style="color:#268bd2">address</span>,
        <span style="color:#268bd2">DateTime</span> <span style="color:#268bd2">birthdate</span>)
    {
        <span style="color:#268bd2">Guard</span>.<span style="color:#268bd2">ForNull</span>(<span style="color:#268bd2">name</span>, <span style="color:#2aa198">&#34;name&#34;</span>);
        <span style="color:#268bd2">Guard</span>.<span style="color:#268bd2">ForNull</span>(<span style="color:#268bd2">address</span>, <span style="color:#2aa198">&#34;address&#34;</span>);
        <span style="color:#268bd2">Guard</span>.<span style="color:#268bd2">ForDateInTheFuture</span>(<span style="color:#268bd2">birthdate</span>, <span style="color:#2aa198">&#34;birthdate&#34;</span>);

        <span style="color:#268bd2">Id</span> = <span style="color:#268bd2">id</span>;
        <span style="color:#268bd2">Name</span> = <span style="color:#268bd2">name</span>;
        <span style="color:#268bd2">Address</span> = <span style="color:#268bd2">address</span>;
        <span style="color:#268bd2">Balance</span> = <span style="color:#2aa198;font-weight:bold">0</span>;
    }

    <span style="color:#859900">public</span> <span style="color:#268bd2">Guid</span> <span style="color:#268bd2">Id</span> { <span style="color:#859900">get</span>; <span style="color:#859900">private</span> <span style="color:#859900">set</span>; }    
    <span style="color:#859900">public</span> <span style="color:#268bd2">Name</span> <span style="color:#268bd2">Name</span> { <span style="color:#859900">get</span>; <span style="color:#859900">private</span> <span style="color:#859900">set</span>; }
    <span style="color:#859900">public</span> <span style="color:#268bd2">Address</span> <span style="color:#268bd2">Address</span> { <span style="color:#859900">get</span>; <span style="color:#859900">private</span> <span style="color:#859900">set</span>; }
    <span style="color:#859900">public</span> <span style="color:#268bd2">DateTime</span> <span style="color:#268bd2">BirthDate</span> { <span style="color:#859900">get</span>; <span style="color:#859900">private</span> <span style="color:#859900">set</span>; }
    <span style="color:#859900">private</span> <span style="color:#859900;font-weight:bold">decimal</span> <span style="color:#268bd2">Balance</span> { <span style="color:#859900">get</span>; <span style="color:#859900">set</span>; }

    <span style="color:#859900">private</span> <span style="color:#859900;font-weight:bold">bool</span> <span style="color:#268bd2">HasSufficientFunds</span>(<span style="color:#859900;font-weight:bold">decimal</span> <span style="color:#859900">value</span>) 
    {
        <span style="color:#859900">return</span> <span style="color:#268bd2">Balance</span> - <span style="color:#859900">value</span> &gt;= <span style="color:#2aa198;font-weight:bold">0</span>;
    }

    <span style="color:#859900">public</span> <span style="color:#859900">void</span> <span style="color:#268bd2">DecreaseBalance</span>(<span style="color:#859900;font-weight:bold">decimal</span> <span style="color:#859900">value</span>)
    {
        <span style="color:#859900">if</span> (<span style="color:#268bd2">HasSufficientFunds</span>(<span style="color:#859900">value</span>))
            <span style="color:#859900">throw</span> <span style="color:#859900">new</span> <span style="color:#268bd2">InsufficientFundsException</span>();

        <span style="color:#268bd2">Balance</span> -= <span style="color:#859900">value</span>;
    }

    <span style="color:#859900">public</span> <span style="color:#859900">void</span> <span style="color:#268bd2">MoveTo</span>(<span style="color:#268bd2">Address</span> <span style="color:#268bd2">newAddress</span>)
    {
        <span style="color:#268bd2">Guard</span>.<span style="color:#268bd2">ForNull</span>(<span style="color:#268bd2">newAddress</span>, <span style="color:#2aa198">&#34;new address&#34;</span>);

        <span style="color:#268bd2">Address</span> = <span style="color:#268bd2">newAddress</span>;
    }
}
</code></pre></div><h3 id="summarized">Summarized</h3>
<p>By making my entities immutable from the start I am guided into adhering
to a bunch of good practices:</p>
<ul>
<li>A constructor</li>
<li>Comparing identities</li>
<li>Defaults</li>
<li>Protecting invariants</li>
<li>Composition and extracting value objects</li>
<li>Tell, don&rsquo;t ask </li>
<li>Making operations explicit</li>
<li>Opening up bit by bit</li>
</ul>

			</div>

			<div class="tags">
				
					
						<ul class="flat">
							
							<li><a href="/tags/code">code</a></li>
							
							<li><a href="/tags/opinion">opinion</a></li>
							
						</ul>
					
				
			</div></div>
	</div>
	<div class="footer wrapper">
	<nav class="nav">
		<div>2013  <a href="https://github.com/knadh/hugo-ink">Ink</a> theme on <a href="https://gohugo.io">Hugo</a></div>
	</nav>
</div>

<script>feather.replace()</script>
</body>
</html>
