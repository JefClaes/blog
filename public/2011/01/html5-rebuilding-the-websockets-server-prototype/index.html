<!DOCTYPE html>
<html>
<head><script src="/livereload.js?port=1313&mindelay=10&v=2" data-no-instant defer></script>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>HTML5: Rebuilding the WebSockets Server prototype - Jef Claes</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta itemprop="name" content="HTML5: Rebuilding the WebSockets Server prototype">
<meta itemprop="description" content="Yesterday I blogged on installing the Microsoft WebSockets prototype with the Chat sample. The Chat sample needs a ChatService to broadcast the messages to all active sessions. The source code of this ChatService is not included in the package, that&rsquo;s why I decompiled the executable using Reflector and rebuilt it.
In this post you can find how to rebuild the Chat Websockets Server.
Class diagram
Once we are finished, our class diagram should look like this.">
<meta itemprop="datePublished" content="2011-01-09T18:45:00&#43;01:00" />
<meta itemprop="dateModified" content="2011-01-09T18:45:00&#43;01:00" />
<meta itemprop="wordCount" content="878">



<meta itemprop="keywords" content="HTML5," /><meta property="og:title" content="HTML5: Rebuilding the WebSockets Server prototype" />
<meta property="og:description" content="Yesterday I blogged on installing the Microsoft WebSockets prototype with the Chat sample. The Chat sample needs a ChatService to broadcast the messages to all active sessions. The source code of this ChatService is not included in the package, that&rsquo;s why I decompiled the executable using Reflector and rebuilt it.
In this post you can find how to rebuild the Chat Websockets Server.
Class diagram
Once we are finished, our class diagram should look like this." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:1313/2011/01/html5-rebuilding-the-websockets-server-prototype/" />
<meta property="article:published_time" content="2011-01-09T18:45:00+01:00" />
<meta property="article:modified_time" content="2011-01-09T18:45:00+01:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="HTML5: Rebuilding the WebSockets Server prototype"/>
<meta name="twitter:description" content="Yesterday I blogged on installing the Microsoft WebSockets prototype with the Chat sample. The Chat sample needs a ChatService to broadcast the messages to all active sessions. The source code of this ChatService is not included in the package, that&rsquo;s why I decompiled the executable using Reflector and rebuilt it.
In this post you can find how to rebuild the Chat Websockets Server.
Class diagram
Once we are finished, our class diagram should look like this."/>
<link href='https://fonts.googleapis.com/css?family=Playfair+Display:700' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" type="text/css" media="screen" href="http://localhost:1313/css/normalize.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="http://localhost:1313/css/main.css" />

        <link id="dark-scheme" rel="stylesheet" type="text/css" href="http://localhost:1313/css/dark.css" />

	<script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
		<script src="http://localhost:1313/js/main.js"></script>
</head>

<body>
	<div class="container wrapper">
		<div class="header">
	
		<div class="avatar">
			<a href="http://localhost:1313/">
				<img src="https://image.freepik.com/free-vector/young-man-head-with-beard-avatar-character_24877-36786.jpg" alt="Jef Claes" />
			</a>
		</div>
	
	<h1 class="site-title"><a href="http://localhost:1313/">Jef Claes</a></h1>
	<div class="site-description"><p>On software and life</p><nav class="nav social">
			<ul class="flat"><li><a href="https://github.com/jefclaes" title="Github"><i data-feather="github"></i></a></li><li><a href="/index.xml" title="RSS"><i data-feather="rss"></i></a></li></ul>
		</nav></div>

	<nav class="nav">
		<ul class="flat">
			
			<li>
				<a href="/">Home</a>
			</li>
			
			<li>
				<a href="/post">All posts</a>
			</li>
			
			<li>
				<a href="/about">About</a>
			</li>
			
			<li>
				<a href="/tags">Tags</a>
			</li>
			
		</ul>
	</nav>
</div>


		<div class="post">
			<div class="post-header">
				
					<div class="meta">
						<div class="date">
							<span class="day">09</span>
							<span class="rest">Jan 2011</span>
						</div>
					</div>
				
				<div class="matter">
					<h1 class="title">HTML5: Rebuilding the WebSockets Server prototype</h1>
				</div>
			</div>
					
			<div class="markdown">
				<p>Yesterday I <a href="http://jclaes.blogspot.com/2011/01/html5-installing-microsoft-websockets.html">blogged on installing the Microsoft WebSockets
prototype</a>
with the Chat sample. The Chat sample needs a ChatService to broadcast
the messages to all active sessions. The source code of this ChatService
is not included in the package, that&rsquo;s why I decompiled the executable
using Reflector and rebuilt it.</p>
<p>In this post you can find how to rebuild the Chat Websockets Server.</p>
<p><strong>Class diagram</strong></p>
<p>Once we are finished, our class diagram should look like this.</p>
<p><a href="/post/images/2011-01-09-html5-rebuilding-the-websockets-server-prototype-classdiagram.PNG"><img src="/post/images/thumbnails/2011-01-09-html5-rebuilding-the-websockets-server-prototype-classdiagram.PNG" alt=""></a><br>
<strong>The server</strong></p>
<p>The server will be hosted in a .NET 4.0 console application.</p>
<p><strong>Dependencies</strong></p>
<p>The server has a few dependencies which are not in the .NET 4.0
Framework:</p>
<ul>
<li>Microsoft.Runtime.Serialization.Json.dll</li>
<li>Microsoft.ServiceModel.WebSockets.dll</li>
<li>Microsoft.ServiceModel.Tcp.dll</li>
</ul>
<p>You can find these assemblies in the %ProgramFiles%\Microsoft SDKs\WCF
WebSockets\10.12.16\bin folder. Make sure you have <a href="http://jclaes.blogspot.com/2011/01/html5-installing-microsoft-websockets.html">installed the
Microsoft WebSockets
prototype</a>.</p>
<p><strong>The service</strong></p>
<p>The Service class needs to inherit from the abstract WebSocketsService
class.</p>
<pre><code>class Service : WebSocketsService 
</code></pre>
<p>The abstract WebSocketsService class has following properties and
methods.</p>
<pre><code>public abstract class WebSocketsService : IWebSockets, IDisposable {

    protected WebSocketsService();

 

    protected WebHeaderCollection HttpRequestHeaders { get; }

    protected Uri HttpRequestUri { get; }

 

    protected void Close();

    public void Dispose();

    protected virtual void Dispose(bool disposing);

    protected virtual void OnClose(object sender, EventArgs e);

    protected virtual void OnError(object sender, EventArgs e);

    public virtual void OnMessage(JsonValue jsonValue);

    public virtual void OnOpen();

    public void Send(JsonValue jsonValue);

}
</code></pre>
<p>The Service class needs to be decorated with a
<a href="http://msdn.microsoft.com/en-us/library/system.servicemodel.servicebehaviorattribute.aspx">ServiceBehavior</a>
attribute. The InstanceContextMode property defines that a new instance
of the service needs to be created per session. The ConcurrencyMode
defines that the service instances are multithreaded. No synchronization
guarantees are made, so synchronization should be handled manually.</p>
<pre><code>[ServiceBehavior(InstanceContextMode = InstanceContextMode.PerSession, 

                ConcurrencyMode = ConcurrencyMode.Multiple)]
</code></pre>
<p>This class needs two static private fields:</p>
<ul>
<li>
<p>static int m_globalId: This field holds a global id, which can be
used to create a unique id for each new service instance.</p>
</li>
<li>
<p>static Sessions m_sessions: This field contains an instance of the
Sessions object, which is used to manage all active service
instances.</p>
<p>private static int m_globalId;</p>
<p>private static Sessions m_sessions = new Sessions();</p>
</li>
</ul>
<p>Next to the static private fields, this class also needs one private
instance field:</p>
<ul>
<li>
<p>int m_id: This field holds an id used as a hash to identify the
service instance.</p>
<p>private int m_id = Interlocked.Increment(ref m_globalId);</p>
</li>
</ul>
<p>In the constructor we add the new service instance to the collection of
already existing active service instances.</p>
<pre><code>public Service() {

    if (!m_sessions.TryAdd(this)) {

        throw new InvalidOperationException(&quot;Can't add session.&quot;);

    }

}
</code></pre>
<p>The GetHashCode() method returns the unique id that is used to identify
the service instance.</p>
<pre><code>public override int GetHashCode() {

    return this.m_id;

}
</code></pre>
<p>When a service is closed, we remove the service from the collection of
active service instances.</p>
<pre><code>protected override void OnClose(object sender, EventArgs e) {            

    m_sessions.Remove(this);           

}
</code></pre>
<p>When the service receives a message, we call the RelayMessage() method
on the Sessions instance.</p>
<pre><code>public override void OnMessage(JsonValue jsonValue) {            

    m_sessions.RelayMessage(jsonValue);

}
</code></pre>
<p><strong>ServiceCollection</strong></p>
<p>This class is used to store a collection of services.</p>
<pre><code>public class ServiceCollection&lt;TService&gt; : KeyedCollection&lt;int, TService&gt; where TService : class {

    protected override int GetKeyForItem(TService item) {

        return item.GetHashCode();

    }

}  
</code></pre>
<p><strong>Sessions</strong></p>
<p>This class is used to manage active service instances.</p>
<p>The internal Sessions class has two private instance fields:</p>
<ul>
<li>
<p>ServiceCollection m_innerCache: This fields holds a collection of
service instances.</p>
</li>
<li>
<p><a href="http://msdn.microsoft.com/en-us/library/system.threading.readerwriterlockslim.aspx">ReaderWriterLockSlim</a>
m_thisLock: This lock is used throughout this class to
thread-safely manage access to resources.</p>
<p>private ServiceCollection<!-- raw HTML omitted --> m_innerCache = new ServiceCollection<!-- raw HTML omitted -->();</p>
<p>private ReaderWriterLockSlim m_thisLock = new ReaderWriterLockSlim();</p>
</li>
</ul>
<p>This class implements
<a href="http://msdn.microsoft.com/en-us/library/system.idisposable.aspx">IDisposable</a>.
In the Dispose() method the ReaderWriterLockSlim is disposed.</p>
<pre><code>public void Dispose() {

    this.m_thisLock.Dispose();

}
</code></pre>
<p>The TryAdd() method takes a service instance and tries to add the
instance to the private collection of service instances.</p>
<pre><code>public bool TryAdd(Service entry) {

    bool flag;

    this.m_thisLock.EnterUpgradeableReadLock();

    try {

        if (this.m_innerCache.Contains(entry)) {

            flag = false;

        } else {

            this.m_thisLock.EnterWriteLock();

            try {

                this.m_innerCache.Add(entry);

                flag = true;

            } finally {

                this.m_thisLock.ExitWriteLock();

            }

        }

    } finally {

        this.m_thisLock.ExitUpgradeableReadLock();

    }

    return flag;

}
</code></pre>
<p>The RelayMessage() method takes a
<a href="http://msdn.microsoft.com/en-us/library/system.json.jsonvalue(v=vs.95).aspx">JsonValue</a>
argument and makes all the services send it.</p>
<pre><code>public void RelayMessage(JsonValue jsonValue) {

    List&lt;Service&gt; list = null;

    this.m_thisLock.EnterReadLock();

    try {

        foreach (Service service in this.m_innerCache) {

            try {

                service.Send(jsonValue);

                continue;

            } catch {

                if (list == null) {

                    list = new List&lt;Service&gt;();

                }

                list.Add(service);

                continue;

            }

        }

    } finally {

        this.m_thisLock.ExitReadLock();

    }

    if (list != null) {

        this.m_thisLock.EnterWriteLock();

        try {

            foreach (Service service2 in list) {

                this.m_innerCache.Remove(service2);

            }

        } finally {

            this.m_thisLock.ExitWriteLock();

        }

    }

}
</code></pre>
<p>The Remove() method takes a service instance and removes it
asynchronously from the private collection of service instances.</p>
<pre><code>public void Remove(Service entry) {

    ThreadPool.QueueUserWorkItem(new WaitCallback(this.RemoveInternal), entry);

}

 

private void RemoveInternal(object state) {

    var item = state as Service;

    if (item != null) {

        this.m_thisLock.EnterWriteLock();

        try {

            this.m_innerCache.Remove(item);

        } finally {

            this.m_thisLock.ExitWriteLock();

        }

    }

}
</code></pre>
<p><strong>Almost there</strong></p>
<p>To finish the WebSockets Server we need to set up the WebSocketsHost in
Program.cs.</p>
<p>Create a new instance of the WebSocketsHost&lt;Service&gt; class passing
in a baseaddress. Add an endpoint and finally open the host.</p>
<pre><code>static void Main(string[] args) {

    var host = new WebSocketsHost&lt;Service&gt;(new Uri[] { new Uri(string.Format(&quot;ws://{0}:4502/chat&quot;, Environment.MachineName)) });

    host.AddWebSocketsEndpoint();

    host.Open();

 

    Console.WriteLine(&quot;Websocket server listening on &quot; + host.Description.Endpoints[0].Address.Uri.AbsoluteUri);

    Console.WriteLine();

  

    using (ManualResetEvent mre = new ManualResetEvent(false)) {

        mre.WaitOne();

    }

    host.Close();

}
</code></pre>
<p>That should be it. You can now run your own implementation of the Chat
WebSockets Server and use Visual Studio to step through the flow of the
server.</p>
<p><!-- raw HTML omitted -->Download the source<!-- raw HTML omitted --></p>
<p>You can <a href="https://dl.dropbox.com/u/19698383/Blog/WebSocketsServer.rar">download the source
here</a>.</p>

			</div>

			<div class="tags">
				
					
						<ul class="flat">
							
							<li><a href="/tags/html5">HTML5</a></li>
							
						</ul>
					
				
			</div></div>
	</div>
	<div class="footer wrapper">
	<nav class="nav">
		<div>2011  <a href="https://github.com/knadh/hugo-ink">Ink</a> theme on <a href="https://gohugo.io">Hugo</a></div>
	</nav>
</div>

<script>feather.replace()</script>
</body>
</html>
