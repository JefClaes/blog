<!DOCTYPE html>
<html>
<head><script src="/livereload.js?port=1313&mindelay=10&v=2" data-no-instant defer></script>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>HTML5: The WebSockets prototype with Silverlight, HTML Bridges and JavaScript - Jef Claes</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta itemprop="name" content="HTML5: The WebSockets prototype with Silverlight, HTML Bridges and JavaScript">
<meta itemprop="description" content="Last weekend, I blogged on installing the WebSockets prototype and rebuilding the WebSockets chat server. In this post I will try to decompose the client-side chat sample to get a better feel of what&rsquo;s going on in the browser.
If you have installed the WebSockets prototype, you should be able to browse to http://localhost/chat/wsdemo.html and stroll through the internals with me.

Dependencies
The chat sample has four script dependencies:">
<meta itemprop="datePublished" content="2011-01-12T19:00:00&#43;01:00" />
<meta itemprop="dateModified" content="2011-01-12T19:00:00&#43;01:00" />
<meta itemprop="wordCount" content="676">



<meta itemprop="keywords" content="HTML5," /><meta property="og:title" content="HTML5: The WebSockets prototype with Silverlight, HTML Bridges and JavaScript" />
<meta property="og:description" content="Last weekend, I blogged on installing the WebSockets prototype and rebuilding the WebSockets chat server. In this post I will try to decompose the client-side chat sample to get a better feel of what&rsquo;s going on in the browser.
If you have installed the WebSockets prototype, you should be able to browse to http://localhost/chat/wsdemo.html and stroll through the internals with me.

Dependencies
The chat sample has four script dependencies:" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:1313/2011/01/html5-the-websockets-prototype-with-silverlight-html-bridges-and-javascript/" />
<meta property="article:published_time" content="2011-01-12T19:00:00+01:00" />
<meta property="article:modified_time" content="2011-01-12T19:00:00+01:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="HTML5: The WebSockets prototype with Silverlight, HTML Bridges and JavaScript"/>
<meta name="twitter:description" content="Last weekend, I blogged on installing the WebSockets prototype and rebuilding the WebSockets chat server. In this post I will try to decompose the client-side chat sample to get a better feel of what&rsquo;s going on in the browser.
If you have installed the WebSockets prototype, you should be able to browse to http://localhost/chat/wsdemo.html and stroll through the internals with me.

Dependencies
The chat sample has four script dependencies:"/>
<link href='https://fonts.googleapis.com/css?family=Playfair+Display:700' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" type="text/css" media="screen" href="http://localhost:1313/css/normalize.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="http://localhost:1313/css/main.css" />

        <link id="dark-scheme" rel="stylesheet" type="text/css" href="http://localhost:1313/css/dark.css" />

	<script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
		<script src="http://localhost:1313/js/main.js"></script>
</head>

<body>
	<div class="container wrapper">
		<div class="header">
	
		<div class="avatar">
			<a href="http://localhost:1313/">
				<img src="https://image.freepik.com/free-vector/young-man-head-with-beard-avatar-character_24877-36786.jpg" alt="Jef Claes" />
			</a>
		</div>
	
	<h1 class="site-title"><a href="http://localhost:1313/">Jef Claes</a></h1>
	<div class="site-description"><p>On software and life</p><nav class="nav social">
			<ul class="flat"><li><a href="https://github.com/jefclaes" title="Github"><i data-feather="github"></i></a></li><li><a href="/index.xml" title="RSS"><i data-feather="rss"></i></a></li></ul>
		</nav></div>

	<nav class="nav">
		<ul class="flat">
			
			<li>
				<a href="/">Home</a>
			</li>
			
			<li>
				<a href="/post">All posts</a>
			</li>
			
			<li>
				<a href="/about">About</a>
			</li>
			
			<li>
				<a href="/tags">Tags</a>
			</li>
			
		</ul>
	</nav>
</div>


		<div class="post">
			<div class="post-header">
				
					<div class="meta">
						<div class="date">
							<span class="day">12</span>
							<span class="rest">Jan 2011</span>
						</div>
					</div>
				
				<div class="matter">
					<h1 class="title">HTML5: The WebSockets prototype with Silverlight, HTML Bridges and JavaScript</h1>
				</div>
			</div>
					
			<div class="markdown">
				<p>Last weekend, I blogged on <a href="http://jclaes.blogspot.com/2011/01/html5-installing-microsoft-websockets.html">installing the WebSockets
prototype</a>
and <a href="http://jclaes.blogspot.com/2011/01/html5-rebuilding-websockets-server.html">rebuilding the WebSockets chat
server</a>.
In this post I will try to decompose the client-side chat sample to get
a better feel of what&rsquo;s going on in the browser.</p>
<p>If you have installed the WebSockets prototype, you should be able to
browse to <a href="http://localhost/chat/wsdemo.html">http://localhost/chat/wsdemo.html</a> and stroll through the
internals with me.</p>
<p><a href="/post/images/2011-01-12-html5-the-websockets-prototype-with-silverlight-html-bridges-and-javascript-chatsample.PNG"><img src="/post/images/thumbnails/2011-01-12-html5-the-websockets-prototype-with-silverlight-html-bridges-and-javascript-chatsample.PNG" alt=""></a><br>
<strong>Dependencies</strong></p>
<p>The chat sample has four script dependencies:</p>
<ul>
<li>jquery-1.4.2.min.js</li>
<li>json2.js</li>
<li>jquery.slws.js</li>
<li>h5utils.js</li>
</ul>
<p>Because there is no sense in having a look inside a minified version of
jQuery, I&rsquo;ll only look at the three others: json2.js, jquery.slws.js and
h5utils.js.</p>
<p><strong>Json2.js</strong></p>
<p>This script creates a global JSON object, if it does not already exist,
containing two methods: stringify and parse.</p>
<p>The
<a href="http://msdn.microsoft.com/en-us/library/cc836459(v=vs.85).aspx">stringify()</a>
method turns a JavaScript value into a JSON text and, oh suprise, the
<a href="http://msdn.microsoft.com/en-us/library/cc836466(v=vs.85).aspx">parse()</a>
method parses a JSON text to a JavaScript value.</p>
<p><strong>jQuery.slws.js</strong></p>
<p>This script is where the biggest part of the WebSockets prototype magic
happens. This script dynamically loads a Silverlight component into your
page. This Silverlight component exposes a bunch of methods through an
<a href="http://msdn.microsoft.com/en-us/library/cc645076(v=vs.95).aspx">HTML
Bridge</a>
which can be used to talk to the WebSockets server.</p>
<pre><code>jQuery(function ($) {

    if (!$.slws) $.slws = {};

    else if (typeof ($.slws) != &quot;object&quot;) {

        throw new Error(&quot;Cannot create jQuery.slws namespace: it already exists and is not an object.&quot;);

    }

 

    $(document).ready(function () {

        var script = document.createElement(&quot;script&quot;);

        document.body.appendChild(script);

        script.src = 'js/Silverlight.js';

        var slhost = document.createElement(&quot;div&quot;);

        document.body.insertBefore(slhost, document.body.firstChild);     

        slhost.innerHTML =

        '&lt;div align=center&gt;' +

        '&lt;object data=&quot;data:application/x-silverlight-2,&quot; type=&quot;application/x-silverlight-2&quot; width=&quot;600&quot; height=&quot;70&quot;&gt;' +

            '&lt;param name=&quot;source&quot; value=&quot;ClientBin/Microsoft.ServiceModel.Websockets.xap&quot;/&gt;' +

            '&lt;param name=&quot;onError&quot; value=&quot;onSilverlightError&quot; /&gt;' +

            '&lt;param name=&quot;background&quot; value=&quot;white&quot; /&gt;' +

            '&lt;param name=&quot;minRuntimeVersion&quot; value=&quot;4.0.50401.0&quot; /&gt;' +

            '&lt;param name=&quot;autoUpgrade&quot; value=&quot;true&quot; /&gt;' +

            '&lt;param name=&quot;onLoad&quot; value=&quot;pluginLoaded&quot; /&gt;' +

            '&lt;a href=&quot;http://go.microsoft.com/fwlink/?LinkID=149156&amp;v=4.0.50401.0&quot; style=&quot;text-decoration:none&quot;&gt;' +

                 '&lt;img src=&quot;http://go.microsoft.com/fwlink/?LinkId=161376&quot; alt=&quot;Get Microsoft Silverlight&quot; style=&quot;border-style:none&quot;/&gt;' +

            '&lt;/a&gt;' +

        '&lt;/object&gt;&lt;iframe id=&quot;_sl_historyFrame&quot; style=&quot;visibility:hidden;height:0px;width:0px;border:0px&quot;&gt;&lt;/iframe&gt;&lt;/div&gt;';

    });

 

    $.slws._callbacks = [];

 

    $.slws.ready = function (callback) {

        if (callback) {

            if ($.slws._loaded) {

                callback();

            }

            else {

                $.slws._callbacks.push(callback);

            }

        }

    }

});
</code></pre>
<p>When the Silverlight component has finished loading, a global
WebSocketDraft object is created wrapping all the functions that are
exposed through the HTML Bridge of the Silverlight component.</p>
<pre><code>function pluginLoaded(sender, args) {

    var slCtl = sender.getHost();

 

    window.WebSocketDraft = function (url) {

        this.slws = slCtl.Content.services.createObject(&quot;websocket&quot;);

        this.slws.Url = url;

        this.readyState = this.slws.ReadyState;

        var thisWs = this;

        this.slws.OnOpen = function (sender, args) {

            thisWs.readyState = thisWs.slws.ReadyState;

            if (thisWs.onopen) thisWs.onopen();

        };

        this.slws.OnMessage = function (sender, args) {

            if (String(args.Message).charAt(0) == '&quot;' &amp;&amp; thisWs.onmessage)

                thisWs.onmessage({ data: String(args.Message) });

        };

        this.slws.OnClose = function (sender, args) {

            thisWs.readyState = thisWs.slws.ReadyState;

            if (thisWs.onclose) thisWs.onclose();

        };

        this.slws.Open();

    };

 

    window.WebSocketDraft.prototype.send = function (message) {

        if (message.charAt(0) != '&quot;')

            message = '&quot;' + message + '&quot;';

        this.slws.Send(message);

    };

 

    window.WebSocketDraft.prototype.close = function() {

        this.slws.Close();

    };

 

    $.slws._loaded = true;

    for (c in $.slws._callbacks) {

        $.slws._callbacks[c]();

    }

}
</code></pre>
<p><strong>H5utils</strong></p>
<p>This script forces IE to acknowledge all new HTML5 elements. More on
this script can be found
<a href="http://remysharp.com/2009/01/07/html5-enabling-script/">here</a>.</p>
<p><strong>Using the WebSockets</strong></p>
<p>Now we have peeked at the script dependencies, we can have a look at the
actual usage of the WebSockets API.</p>
<p><strong>Opening a WebSocket</strong></p>
<p>Opening a connection to a WebSocket is very straightforward. Simply
create a new WebSocketDraft instance and pass in the endpoint to your
WebSockets server.</p>
<pre><code>conn = new WebSocketDraft('ws://' + window.location.hostname + ':4502/chat');
</code></pre>
<p><strong>Handling events</strong></p>
<p>Events that are handled in this sample are onopen, onmessage and
onclose.</p>
<pre><code>conn.onopen = function () {

    state.className = 'success';

    state.innerHTML = 'Socket open';

};

 

conn.onmessage = function (event) {

    var message = JSON.parse(event.data);

    if (typeof message == 'string') {

        log.innerHTML = '&lt;li class=&quot;them&quot;&gt;' + 

                        message.replace(/[&lt;&gt;&amp;]/g, function (m) { return entities[m]; }) + 

                        '&lt;/li&gt;' + log.innerHTML;

    } else {

        connected.innerHTML = message;

    }

};

 

conn.onclose = function (event) {

    state.className = 'fail';

    state.innerHTML = 'Socket closed';

};
</code></pre>
<p><strong>Sending a message</strong></p>
<p>You can send a message using the send() method. Pass in a JSON text.</p>
<pre><code>if (conn.readyState === 1) {

    conn.send(JSON.stringify(chat.value));    

}
</code></pre>
<p><strong>Conclusions</strong></p>
<p>The Silverlight solution is a creative hack which allows us to play
client-side with the WebSockets prototype until it is natively
implemented by IE.</p>
<p>I am satisfied with the WebSocket API specifications, very simple to
use. What are your thoughts on the API?</p>

			</div>

			<div class="tags">
				
					
						<ul class="flat">
							
							<li><a href="/tags/html5">HTML5</a></li>
							
						</ul>
					
				
			</div></div>
	</div>
	<div class="footer wrapper">
	<nav class="nav">
		<div>2011  <a href="https://github.com/knadh/hugo-ink">Ink</a> theme on <a href="https://gohugo.io">Hugo</a></div>
	</nav>
</div>

<script>feather.replace()</script>
</body>
</html>
